<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>流量・水質測定集計アシスタント</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .lcd-display {
            font-family: 'Courier New', Courier, monospace;
            background-color: #f8fafc;
            border: 4px solid #1e293b;
        }
        @keyframes pulse-red {
            0%, 100% { background-color: rgba(244, 63, 94, 0.1); }
            50% { background-color: rgba(244, 63, 94, 0.3); }
        }
        .countdown-active {
            animation: pulse-red 1s infinite;
        }
        @media print {
            .no-print { display: none !important; }
            body { background-color: white !important; padding: 0 !important; }
            .max-w-md { max-width: 100% !important; box-shadow: none !important; border: none !important; }
            .location-group { break-inside: avoid; border: 1px solid #ccc !important; padding: 1rem !important; margin-bottom: 2rem !important; }
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 pb-20 font-sans">

    <div class="max-w-md mx-auto bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-200">
        <!-- Header -->
        <div class="bg-slate-800 text-white p-4 text-center">
            <h1 class="text-xl font-bold">流量 & 水質調査アシスタント</h1>
            <p class="text-[10px] opacity-70 mt-1 no-print">複数測定・平均算出・CSV/PDF対応</p>
        </div>

        <div class="p-5 space-y-6">
            <!-- Data Entry (No Print) -->
            <div class="grid grid-cols-2 gap-3 no-print">
                <div class="col-span-2">
                    <label class="text-xs font-bold text-slate-500 uppercase">地点名</label>
                    <input type="text" id="location-name" placeholder="例: A地点" class="w-full border-b-2 border-slate-200 focus:border-blue-500 outline-none py-1">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">水温 (℃)</label>
                    <input type="number" id="temp" step="0.1" class="w-full border-b-2 border-slate-200 focus:border-blue-500 outline-none py-1">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">pH</label>
                    <input type="number" id="ph" step="0.01" class="w-full border-b-2 border-slate-200 focus:border-blue-500 outline-none py-1">
                </div>
                <div class="col-span-2">
                    <label class="text-xs font-bold text-slate-500 uppercase">EC (mS/m)</label>
                    <input type="number" id="ec" step="0.1" class="w-full border-b-2 border-slate-200 focus:border-blue-500 outline-none py-1">
                </div>
                <div class="col-span-2">
                    <label class="text-xs font-bold text-slate-500 uppercase">備考</label>
                    <textarea id="notes" rows="1" class="w-full border-2 border-slate-100 rounded-lg p-2 text-sm focus:border-blue-500 outline-none"></textarea>
                </div>
            </div>

            <!-- Stopwatch (No Print) -->
            <div class="space-y-4 no-print border-t pt-4">
                <div id="lcd-container" class="lcd-display rounded-2xl p-6 text-center relative">
                    <div id="timer-label" class="text-xs font-bold text-slate-400 mb-1 uppercase">Stopped</div>
                    <div id="timer-display" class="text-5xl font-bold text-slate-800">00:00.00</div>
                    <div id="countdown-overlay" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 rounded-2xl hidden z-10">
                        <span id="countdown-value" class="text-6xl font-black text-rose-500">5</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button id="start-btn" class="bg-emerald-600 text-white font-bold py-4 rounded-xl shadow-md active:scale-95 transition-all">スタート</button>
                    <button id="stop-btn" class="bg-rose-600 text-white font-bold py-4 rounded-xl shadow-md disabled:opacity-50 transition-all" disabled>ストップ</button>
                </div>

                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <input type="number" id="target-seconds" value="10" class="w-12 border rounded text-center font-bold">
                        <span class="text-xs text-blue-700">秒計測</span>
                        <input type="checkbox" id="timer-toggle" class="w-4 h-4">
                    </div>
                    <button id="reset-btn" class="text-xs bg-slate-200 px-3 py-1 rounded font-bold hover:bg-slate-300">リセット</button>
                </div>
            </div>

            <!-- Calculation (No Print) -->
            <div id="calc-section" class="hidden no-print space-y-4 border-t pt-4">
                <div class="flex space-x-2">
                    <input type="number" id="water-volume" step="0.001" placeholder="採取量 (L)" class="flex-1 border-2 border-slate-200 rounded-lg px-3 py-2 text-lg outline-none">
                    <button id="calc-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">計算</button>
                </div>
                <div id="result-card" class="hidden bg-emerald-600 text-white p-4 rounded-xl text-center">
                    <div class="text-4xl font-black"><span id="flow-rate">0.00</span> <small class="text-lg">L/min</small></div>
                    <button id="save-btn" class="mt-3 w-full bg-white text-emerald-700 py-2 rounded-lg font-bold text-sm hover:bg-emerald-50">計測結果を記録する</button>
                </div>
            </div>

            <!-- History Section -->
            <div class="space-y-4">
                <div class="flex items-center justify-between no-print">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">地点別データ集計</h3>
                    <div class="flex space-x-1">
                        <button id="print-all-btn" class="text-[10px] bg-slate-800 text-white px-3 py-1 rounded hover:bg-slate-700">PDF出力</button>
                        <button id="csv-all-btn" class="text-[10px] bg-slate-600 text-white px-3 py-1 rounded hover:bg-slate-500">CSV出力</button>
                    </div>
                </div>
                
                <div class="hidden print:block border-b-2 border-slate-800 mb-6 pb-2">
                    <h2 class="text-2xl font-bold">流量・水質調査報告書</h2>
                    <p id="print-date" class="text-sm text-slate-500 mt-1"></p>
                </div>

                <!-- Grouped Content -->
                <div id="history-groups" class="space-y-8 pb-10">
                    <p id="no-data-msg" class="text-center text-slate-400 text-xs py-8">計測データはありません</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            if (type === 'start') {
                osc.frequency.setValueAtTime(880, audioCtx.currentTime); 
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.2);
            } else {
                osc.type = 'square'; osc.frequency.setValueAtTime(440, audioCtx.currentTime); 
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5);
            }
            osc.start(); osc.stop(audioCtx.currentTime + (type === 'start' ? 0.2 : 0.5));
        }

        let startTime, elapsedTime = 0, timerInterval, isRunning = false;
        let allData = {}; // { locationName: [records] }

        const display = document.getElementById('timer-display');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const resetBtn = document.getElementById('reset-btn');
        const historyGroups = document.getElementById('history-groups');

        function formatTime(ms) {
            const m = Math.floor(ms / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            const c = Math.floor((ms % 1000) / 10);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}.${c.toString().padStart(2, '0')}`;
        }

        async function startFlowMeasurement() {
            if (isRunning) return;
            const useTimer = document.getElementById('timer-toggle').checked;
            const targetSec = parseFloat(document.getElementById('target-seconds').value);

            if (useTimer) {
                startBtn.disabled = true;
                document.getElementById('countdown-overlay').classList.remove('hidden');
                for (let i = 5; i > 0; i--) {
                    document.getElementById('countdown-value').textContent = i;
                    await new Promise(r => setTimeout(r, 1000));
                }
                document.getElementById('countdown-overlay').classList.add('hidden');
            }

            isRunning = true;
            playSound('start');
            startTime = Date.now() - elapsedTime;
            startBtn.disabled = true; stopBtn.disabled = false;
            document.getElementById('timer-label').textContent = "Running";

            timerInterval = setInterval(() => {
                elapsedTime = Date.now() - startTime;
                display.textContent = formatTime(elapsedTime);
                if (useTimer && elapsedTime >= targetSec * 1000) {
                    elapsedTime = targetSec * 1000;
                    display.textContent = formatTime(elapsedTime);
                    stopFlowMeasurement();
                }
            }, 10);
        }

        function stopFlowMeasurement() {
            if (!isRunning) return;
            clearInterval(timerInterval);
            isRunning = false;
            playSound('stop');
            startBtn.disabled = false; stopBtn.disabled = true;
            document.getElementById('timer-label').textContent = "Finished";
            document.getElementById('calc-section').classList.remove('hidden');
        }

        startBtn.addEventListener('click', startFlowMeasurement);
        stopBtn.addEventListener('click', stopFlowMeasurement);
        
        resetBtn.addEventListener('click', () => {
            if (isRunning) stopFlowMeasurement();
            elapsedTime = 0;
            display.textContent = "00:00.00";
            document.getElementById('timer-label').textContent = "Ready";
            document.getElementById('calc-section').classList.add('hidden');
            document.getElementById('result-card').classList.add('hidden');
        });

        document.getElementById('calc-btn').addEventListener('click', () => {
            const vol = parseFloat(document.getElementById('water-volume').value);
            const mins = (elapsedTime / 1000) / 60;
            if (vol > 0 && mins > 0) {
                document.getElementById('flow-rate').textContent = (vol / mins).toFixed(3);
                document.getElementById('result-card').classList.remove('hidden');
            }
        });

        document.getElementById('save-btn').addEventListener('click', () => {
            const locName = document.getElementById('location-name').value || "未指定地点";
            const record = {
                id: Date.now(),
                time: new Date().toLocaleString(),
                temp: parseFloat(document.getElementById('temp').value) || null,
                ph: parseFloat(document.getElementById('ph').value) || null,
                ec: parseFloat(document.getElementById('ec').value) || null,
                notes: document.getElementById('notes').value,
                rate: parseFloat(document.getElementById('flow-rate').textContent),
                duration: formatTime(elapsedTime),
                vol: document.getElementById('water-volume').value,
                use: true
            };

            if (!allData[locName]) allData[locName] = [];
            allData[locName].push(record);
            renderHistory();
            document.getElementById('result-card').classList.add('hidden');
        });

        function renderHistory() {
            const keys = Object.keys(allData);
            if (keys.length === 0) {
                historyGroups.innerHTML = '<p id="no-data-msg" class="text-center text-slate-400 text-xs py-8">計測データはありません</p>';
                return;
            }
            
            historyGroups.innerHTML = '';
            keys.forEach(loc => {
                const records = allData[loc];
                const activeRecords = records.filter(r => r.use);
                
                const avgRate = activeRecords.length ? (activeRecords.reduce((s, r) => s + r.rate, 0) / activeRecords.length).toFixed(3) : "0.000";
                const avgTemp = activeRecords.filter(r=>r.temp!==null).length ? (activeRecords.reduce((s, r) => s + (r.temp || 0), 0) / activeRecords.filter(r=>r.temp!==null).length).toFixed(1) : "--";
                const avgPh = activeRecords.filter(r=>r.ph!==null).length ? (activeRecords.reduce((s, r) => s + (r.ph || 0), 0) / activeRecords.filter(r=>r.ph!==null).length).toFixed(2) : "--";
                const avgEc = activeRecords.filter(r=>r.ec!==null).length ? (activeRecords.reduce((s, r) => s + (r.ec || 0), 0) / activeRecords.filter(r=>r.ec!==null).length).toFixed(1) : "--";

                const groupDiv = document.createElement('div');
                groupDiv.className = "location-group bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden";
                
                let tableRows = records.map((r, idx) => `
                    <tr class="${r.use ? '' : 'bg-slate-50 text-slate-300'}">
                        <td class="px-3 py-2 no-print">
                            <input type="checkbox" ${r.use ? 'checked' : ''} onclick="toggleUse('${loc}', ${idx})">
                        </td>
                        <td class="px-3 py-2">${r.time.split(' ')[1]}</td>
                        <td class="px-3 py-2 font-bold">${r.rate.toFixed(3)}</td>
                        <td class="px-3 py-2">${r.temp || '-'}/${r.ph || '-'}/${r.ec || '-'}</td>
                    </tr>
                    ${r.notes ? `<tr class="${r.use ? '' : 'text-slate-300'}"><td colspan="4" class="px-3 py-1 text-[9px] italic border-b opacity-70">備考: ${r.notes}</td></tr>` : ''}
                `).join('');

                groupDiv.innerHTML = `
                    <div class="bg-slate-100 px-4 py-2 border-b flex justify-between items-center">
                        <h4 class="font-bold text-slate-700">${loc} <span class="text-xs font-normal text-slate-500">(${records.length}件)</span></h4>
                        <button onclick="downloadCSV('${loc}')" class="no-print text-[9px] bg-white border border-slate-300 px-2 py-0.5 rounded shadow-sm hover:bg-slate-50">CSV</button>
                    </div>
                    <div class="grid grid-cols-4 gap-1 p-3 bg-emerald-50/30 border-b">
                        <div class="text-center"><p class="text-[8px] text-emerald-600 font-bold">AVG FLOW</p><p class="text-sm font-black text-emerald-800">${avgRate}</p></div>
                        <div class="text-center"><p class="text-[8px] text-slate-400 font-bold">AVG TEMP</p><p class="text-xs font-bold text-slate-600">${avgTemp}℃</p></div>
                        <div class="text-center"><p class="text-[8px] text-slate-400 font-bold">AVG PH</p><p class="text-xs font-bold text-slate-600">${avgPh}</p></div>
                        <div class="text-center"><p class="text-[8px] text-slate-400 font-bold">AVG EC</p><p class="text-xs font-bold text-slate-600">${avgEc}</p></div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-[10px] text-left">
                            <thead class="bg-slate-50 text-slate-500 uppercase">
                                <tr><th class="px-3 py-2 no-print w-8">採用</th><th class="px-3 py-2">時刻</th><th class="px-3 py-2">L/min</th><th class="px-3 py-2">T/pH/EC</th></tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">${tableRows}</tbody>
                        </table>
                    </div>
                `;
                historyGroups.appendChild(groupDiv);
            });
        }

        window.toggleUse = (loc, idx) => {
            allData[loc][idx].use = !allData[loc][idx].use;
            renderHistory();
        };

        // CSVエクスポート用関数
        function generateCSVBlob(locName = null) {
            let csv = "\uFEFF地点名,採用,計測日時,流量(L/min),計測時間,採取量(L),水温(C),pH,EC(mS/m),備考\n";
            const keys = locName ? [locName] : Object.keys(allData);
            
            keys.forEach(loc => {
                allData[loc].forEach(r => {
                    const row = [
                        loc,
                        r.use ? "採用" : "不採用",
                        r.time,
                        r.rate,
                        r.duration,
                        r.vol,
                        r.temp || "",
                        r.ph || "",
                        r.ec || "",
                        `"${(r.notes || "").replace(/"/g, '""')}"`
                    ];
                    csv += row.join(",") + "\n";
                });
            });
            return new Blob([csv], { type: "text/csv;charset=utf-8;" });
        }

        window.downloadCSV = (loc) => {
            const blob = generateCSVBlob(loc);
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `flow_report_${loc}_${new Date().getTime()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // 全体エクスポートと印刷
        document.getElementById('csv-all-btn').addEventListener('click', () => {
            if (Object.keys(allData).length === 0) return;
            const blob = generateCSVBlob();
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `flow_report_all_${new Date().getTime()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        document.getElementById('print-all-btn').addEventListener('click', () => {
            if (Object.keys(allData).length === 0) {
                alert("出力するデータがありません");
                return;
            }
            window.print();
        });

        window.onbeforeprint = () => {
            document.getElementById('print-date').textContent = `出力日時: ${new Date().toLocaleString()}`;
        };
    </script>
</body>
</html>

